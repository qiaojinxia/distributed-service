# åˆ†å¸ƒå¼å¾®æœåŠ¡ Docker éƒ¨ç½²æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼å¾®æœåŠ¡åº”ç”¨çš„ Docker å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…å«äº† MySQLã€Redisã€RabbitMQã€Consulã€Prometheusã€Grafana ç­‰å®Œæ•´çš„æœåŠ¡æ ˆã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“± åº”ç”¨æœåŠ¡ (Go + Gin)                                     â”‚
â”‚  â”œâ”€â”€ API å±‚ (RESTful + Swagger)                            â”‚
â”‚  â”œâ”€â”€ æœåŠ¡å±‚ (Business Logic)                               â”‚
â”‚  â”œâ”€â”€ ä»“åº“å±‚ (Data Access)                                  â”‚
â”‚  â””â”€â”€ æ¨¡å‹å±‚ (Data Models)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ—„ï¸ æ•°æ®å­˜å‚¨                                               â”‚
â”‚  â”œâ”€â”€ MySQL (ä¸»æ•°æ®åº“)                                       â”‚
â”‚  â”œâ”€â”€ Redis (ç¼“å­˜)                                          â”‚
â”‚  â””â”€â”€ RabbitMQ (æ¶ˆæ¯é˜Ÿåˆ—)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”§ åŸºç¡€è®¾æ–½                                                â”‚
â”‚  â”œâ”€â”€ Consul (æœåŠ¡æ³¨å†Œä¸å‘ç°)                                â”‚
â”‚  â”œâ”€â”€ Prometheus (ç›‘æ§æŒ‡æ ‡æ”¶é›†)                              â”‚
â”‚  â””â”€â”€ Grafana (å¯è§†åŒ–é¢æ¿)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å‰ç½®è¦æ±‚

- Docker >= 20.10
- Docker Compose >= 1.29
- è‡³å°‘ 4GB å¯ç”¨å†…å­˜
- è‡³å°‘ 10GB å¯ç”¨ç£ç›˜ç©ºé—´

## ğŸš€ ä¸€é”®éƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
./deploy.sh
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up --build -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f app
```

## ğŸ“Š æœåŠ¡è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| ä¸»åº”ç”¨ | http://localhost:8080 | API æœåŠ¡ |
| API æ–‡æ¡£ | http://localhost:8080/swagger/index.html | Swagger UI |
| å¥åº·æ£€æŸ¥ | http://localhost:8080/health | æœåŠ¡å¥åº·çŠ¶æ€ |
| æŒ‡æ ‡ç›‘æ§ | http://localhost:9090/metrics | Prometheus æŒ‡æ ‡ |
| æœåŠ¡æ³¨å†Œä¸­å¿ƒ | http://localhost:8500 | Consul UI |
| æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç† | http://localhost:15672 | RabbitMQ Management (guest/guest) |
| ç›‘æ§ç³»ç»Ÿ | http://localhost:9091 | Prometheus UI |
| å¯è§†åŒ–é¢æ¿ | http://localhost:3000 | Grafana (admin/admin123) |

## ğŸ§ª API æµ‹è¯•

### åˆ›å»ºç”¨æˆ·
```bash
curl -X POST http://localhost:8080/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","email":"test@example.com","password":"password123"}'
```

### è·å–ç”¨æˆ·
```bash
curl http://localhost:8080/api/v1/users/1
```

### åˆ é™¤ç”¨æˆ·
```bash
curl -X DELETE http://localhost:8080/api/v1/users/1
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒé…ç½®æ–‡ä»¶

- `config/config.yaml` - æœ¬åœ°å¼€å‘é…ç½®
- `config/config-docker.yaml` - Docker ç¯å¢ƒé…ç½®
- `config/redis.conf` - Redis é…ç½®
- `config/prometheus.yml` - Prometheus é…ç½®

### æ•°æ®åº“é…ç½®

MySQL é»˜è®¤é…ç½®ï¼š
- ç”¨æˆ·å: `root`
- å¯†ç : `root`
- æ•°æ®åº“: `distributed_service`
- ç«¯å£: `3306`

### æ¶ˆæ¯é˜Ÿåˆ—é…ç½®

RabbitMQ é»˜è®¤é…ç½®ï¼š
- ç”¨æˆ·å: `guest`
- å¯†ç : `guest`
- ç«¯å£: `5672` (AMQP), `15672` (Management)

## ğŸ“ ç›®å½•ç»“æ„

```
distributed-service/
â”œâ”€â”€ Dockerfile                    # åº”ç”¨æ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yaml          # æœåŠ¡ç¼–æ’æ–‡ä»¶
â”œâ”€â”€ deploy.sh                    # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ .dockerignore                # Docker å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ config/                      # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ config.yaml             # æœ¬åœ°é…ç½®
â”‚   â”œâ”€â”€ config-docker.yaml      # Docker é…ç½®
â”‚   â”œâ”€â”€ redis.conf              # Redis é…ç½®
â”‚   â””â”€â”€ prometheus.yml          # Prometheus é…ç½®
â”œâ”€â”€ scripts/                     # åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ mysql-init.sql          # MySQL åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ internal/                    # åº”ç”¨æºç 
â”‚   â”œâ”€â”€ api/                    # API å±‚
â”‚   â”œâ”€â”€ service/                # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ repository/             # ä»“åº“å±‚
â”‚   â””â”€â”€ model/                  # æ¨¡å‹å±‚
â”œâ”€â”€ pkg/                        # å…¬å…±åŒ…
â”‚   â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database/               # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ logger/                 # æ—¥å¿—ç®¡ç†
â”‚   â”œâ”€â”€ middleware/             # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ metrics/                # æŒ‡æ ‡æ”¶é›†
â”‚   â”œâ”€â”€ mq/                     # æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â””â”€â”€ registry/               # æœåŠ¡æ³¨å†Œ
â””â”€â”€ docs/                       # Swagger æ–‡æ¡£
```

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
docker-compose ps
```

### æŸ¥çœ‹åº”ç”¨æ—¥å¿—
```bash
docker-compose logs -f app
```

### æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
```bash
docker-compose logs -f
```

### é‡å¯æœåŠ¡
```bash
docker-compose restart app
```

### åœæ­¢æ‰€æœ‰æœåŠ¡
```bash
docker-compose down
```

### é‡æ–°æ„å»ºåº”ç”¨
```bash
docker-compose up --build -d app
```

### æ¸…ç†æ‰€æœ‰æ•°æ®
```bash
docker-compose down -v --remove-orphans
```

## ğŸ” æ•…éšœæ’æŸ¥

### åº”ç”¨å¯åŠ¨å¤±è´¥

1. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
2. ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼š`docker-compose logs app`

### æ•°æ®åº“è¿æ¥å¤±è´¥

1. æ£€æŸ¥ MySQL å®¹å™¨çŠ¶æ€ï¼š`docker-compose ps mysql`
2. æŸ¥çœ‹ MySQL æ—¥å¿—ï¼š`docker-compose logs mysql`
3. ç¡®ä¿é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯æ­£ç¡®

### æœåŠ¡æ³¨å†Œå¤±è´¥

1. æ£€æŸ¥ Consul å®¹å™¨çŠ¶æ€ï¼š`docker-compose ps consul`
2. è®¿é—® Consul UIï¼šhttp://localhost:8500
3. ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸

## ğŸ“ˆ ç›‘æ§å’ŒæŒ‡æ ‡

### Prometheus æŒ‡æ ‡
- HTTP è¯·æ±‚æ•°é‡å’Œå“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- ç¼“å­˜å‘½ä¸­ç‡
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

### Grafana é¢æ¿
é»˜è®¤è´¦å·ï¼š`admin` / `admin123`

å¯ä»¥å¯¼å…¥é¢„å®šä¹‰çš„é¢æ¿æ¥ç›‘æ§æœåŠ¡æ€§èƒ½ã€‚

## ğŸ” å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ—¶ï¼Œè¯·ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç **
2. **é…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œé™åˆ¶ç«¯å£è®¿é—®**
3. **ä½¿ç”¨ HTTPS å’Œ TLS åŠ å¯†é€šä¿¡**
4. **å®šæœŸæ›´æ–°é•œåƒå’Œä¾èµ–**
5. **é…ç½®æ—¥å¿—è½®è½¬å’Œç›‘æ§å‘Šè­¦**

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

1. åœ¨ `internal/model/` ä¸­å®šä¹‰æ•°æ®æ¨¡å‹
2. åœ¨ `internal/repository/` ä¸­å®ç°æ•°æ®è®¿é—®
3. åœ¨ `internal/service/` ä¸­å®ç°ä¸šåŠ¡é€»è¾‘
4. åœ¨ `internal/api/` ä¸­å®ç° HTTP å¤„ç†å™¨
5. åœ¨ `internal/api/router.go` ä¸­æ³¨å†Œè·¯ç”±
6. é‡æ–°ç”Ÿæˆ Swagger æ–‡æ¡£ï¼š`swag init`

### ä¿®æ”¹é…ç½®

1. æ›´æ–° `config/config-docker.yaml`
2. é‡å¯åº”ç”¨ï¼š`docker-compose restart app`

## ğŸ†˜ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. åº”ç”¨æ—¥å¿—
2. å„æœåŠ¡çš„å¥åº·æ£€æŸ¥çŠ¶æ€
3. Prometheus ç›‘æ§æŒ‡æ ‡
4. æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ† 