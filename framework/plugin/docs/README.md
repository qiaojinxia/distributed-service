# æ’ä»¶æ¨¡å—è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æ’ä»¶æ¨¡å—æ˜¯åˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶çš„æ‰©å±•æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›åŠ¨æ€æ’ä»¶åŠ è½½ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†å’Œäº‹ä»¶æ€»çº¿åŠŸèƒ½ã€‚æ”¯æŒçƒ­æ’æ‹”ã€ä¾èµ–ç®¡ç†ã€å®‰å…¨éš”ç¦»å’Œæ’ä»¶é€šä¿¡ï¼Œå®ç°æ¡†æ¶çš„é«˜åº¦å¯æ‰©å±•æ€§ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨ç¨‹åºå±‚                            â”‚
â”‚                Application Layer                        â”‚
â”‚              Plugin Management API                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ’ä»¶ç®¡ç†å±‚                             â”‚
â”‚                Plugin Management Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   æ’ä»¶æ³¨å†Œè¡¨    â”‚   ç”Ÿå‘½å‘¨æœŸç®¡ç†   â”‚   ä¾èµ–è§£æå™¨    â”‚ â”‚
â”‚  â”‚Plugin Registry â”‚Lifecycle Manager â”‚Dependency Resolverâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   äº‹ä»¶é€šä¿¡å±‚                             â”‚
â”‚               Event Communication Layer                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    äº‹ä»¶æ€»çº¿     â”‚   æ¶ˆæ¯é˜Ÿåˆ—      â”‚   è°ƒåº¦å™¨        â”‚ â”‚
â”‚  â”‚  Event Bus      â”‚Message Queue    â”‚  Scheduler      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ’ä»¶å®ä¾‹å±‚                             â”‚
â”‚                Plugin Instance Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ä¸šåŠ¡æ’ä»¶      â”‚   ä¸­é—´ä»¶æ’ä»¶    â”‚   ç³»ç»Ÿæ’ä»¶      â”‚ â”‚
â”‚  â”‚Business Plugin  â”‚Middleware Pluginâ”‚ System Plugin   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒç‰¹ç‚¹

### 1. åŠ¨æ€åŠ è½½
- **çƒ­æ’æ‹”**: è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œå¸è½½æ’ä»¶
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒæ’ä»¶ç‰ˆæœ¬æ§åˆ¶å’Œå‡çº§
- **ä¾èµ–è§£æ**: è‡ªåŠ¨è§£æå’Œç®¡ç†æ’ä»¶ä¾èµ–å…³ç³»
- **éš”ç¦»æœºåˆ¶**: æ’ä»¶ä¹‹é—´çš„å®‰å…¨éš”ç¦»å’Œèµ„æºæ§åˆ¶

### 2. ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **åˆå§‹åŒ–é˜¶æ®µ**: æ’ä»¶åŠ è½½å’Œé…ç½®éªŒè¯
- **å¯åŠ¨é˜¶æ®µ**: æ’ä»¶æœåŠ¡å¯åŠ¨å’Œèµ„æºåˆ†é…
- **è¿è¡Œé˜¶æ®µ**: æ’ä»¶æ­£å¸¸è¿è¡Œå’Œäº‹ä»¶å¤„ç†
- **åœæ­¢é˜¶æ®µ**: ä¼˜é›…å…³é—­å’Œèµ„æºæ¸…ç†

### 3. äº‹ä»¶é©±åŠ¨
- **äº‹ä»¶æ€»çº¿**: ç»Ÿä¸€çš„äº‹ä»¶å‘å¸ƒå’Œè®¢é˜…æœºåˆ¶
- **å¼‚æ­¥å¤„ç†**: æ”¯æŒå¼‚æ­¥äº‹ä»¶å¤„ç†å’Œå›è°ƒ
- **äº‹ä»¶è·¯ç”±**: æ™ºèƒ½äº‹ä»¶è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„äº‹ä»¶å¤„ç†é”™è¯¯æœºåˆ¶

### 4. å®‰å…¨æ§åˆ¶
- **æƒé™ç®¡ç†**: åŸºäºè§’è‰²çš„æ’ä»¶æƒé™æ§åˆ¶
- **èµ„æºé™åˆ¶**: CPUã€å†…å­˜ç­‰èµ„æºä½¿ç”¨é™åˆ¶
- **æ²™ç®±æœºåˆ¶**: æ’ä»¶è¿è¡Œæ²™ç®±ç¯å¢ƒ
- **å®¡è®¡æ—¥å¿—**: æ’ä»¶æ“ä½œå®¡è®¡å’Œç›‘æ§

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºåŸºç¡€æ’ä»¶

```go
package main

import (
    "context"
    "github.com/qiaojinxia/distributed-service/framework/plugin"
)

// å®ç°æ’ä»¶æ¥å£
type HelloPlugin struct {
    plugin.BasePlugin
    config *HelloConfig
}

type HelloConfig struct {
    Message string `yaml:"message"`
    Enabled bool   `yaml:"enabled"`
}

func (p *HelloPlugin) Name() string {
    return "hello-plugin"
}

func (p *HelloPlugin) Version() string {
    return "1.0.0"
}

func (p *HelloPlugin) Description() string {
    return "A simple hello world plugin"
}

func (p *HelloPlugin) Dependencies() []string {
    return []string{"logger-plugin"} // ä¾èµ–æ—¥å¿—æ’ä»¶
}

func (p *HelloPlugin) Initialize(ctx context.Context, config interface{}) error {
    cfg, ok := config.(*HelloConfig)
    if !ok {
        return plugin.ErrInvalidConfig
    }
    
    p.config = cfg
    p.Logger().Info("Hello plugin initialized", 
        plugin.String("message", cfg.Message))
    return nil
}

func (p *HelloPlugin) Start(ctx context.Context) error {
    if !p.config.Enabled {
        return plugin.ErrPluginDisabled
    }
    
    // è®¢é˜…äº‹ä»¶
    p.EventBus().Subscribe("user.login", p.handleUserLogin)
    p.EventBus().Subscribe("user.logout", p.handleUserLogout)
    
    p.Logger().Info("Hello plugin started")
    return nil
}

func (p *HelloPlugin) Stop(ctx context.Context) error {
    // å–æ¶ˆäº‹ä»¶è®¢é˜…
    p.EventBus().Unsubscribe("user.login", p.handleUserLogin)
    p.EventBus().Unsubscribe("user.logout", p.handleUserLogout)
    
    p.Logger().Info("Hello plugin stopped")
    return nil
}

func (p *HelloPlugin) handleUserLogin(event plugin.Event) {
    userID := event.Data["user_id"].(string)
    p.Logger().Info("User logged in", plugin.String("user_id", userID))
    
    // å‘å¸ƒæ¬¢è¿äº‹ä»¶
    welcomeEvent := plugin.Event{
        Type: "user.welcome",
        Data: map[string]interface{}{
            "user_id": userID,
            "message": p.config.Message,
        },
    }
    p.EventBus().Publish(welcomeEvent)
}

func (p *HelloPlugin) handleUserLogout(event plugin.Event) {
    userID := event.Data["user_id"].(string)
    p.Logger().Info("User logged out", plugin.String("user_id", userID))
}

// æ’ä»¶å·¥å‚å‡½æ•°
func NewHelloPlugin() plugin.Plugin {
    return &HelloPlugin{}
}

// æ³¨å†Œæ’ä»¶
func init() {
    plugin.Register("hello-plugin", NewHelloPlugin)
}
```

### æ’ä»¶ç®¡ç†å™¨ä½¿ç”¨

```go
package main

import (
    "context"
    "time"
    "github.com/qiaojinxia/distributed-service/framework/plugin"
)

func main() {
    // åˆ›å»ºæ’ä»¶ç®¡ç†å™¨
    manager := plugin.NewManager(plugin.ManagerConfig{
        PluginDir:      "./plugins",
        ConfigDir:      "./config/plugins",
        MaxConcurrency: 10,
        Timeout:        30 * time.Second,
    })
    
    // æ³¨å†Œæ’ä»¶é…ç½®
    helloConfig := &HelloConfig{
        Message: "æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„æœåŠ¡ï¼",
        Enabled: true,
    }
    
    // åŠ è½½æ’ä»¶
    ctx := context.Background()
    err := manager.LoadPlugin(ctx, "hello-plugin", helloConfig)
    if err != nil {
        panic(err)
    }
    
    // å¯åŠ¨æ‰€æœ‰æ’ä»¶
    err = manager.StartAll(ctx)
    if err != nil {
        panic(err)
    }
    
    // æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•äº‹ä»¶
    loginEvent := plugin.Event{
        Type: "user.login",
        Data: map[string]interface{}{
            "user_id": "12345",
            "ip":      "192.168.1.100",
        },
    }
    manager.EventBus().Publish(loginEvent)
    
    // ç­‰å¾…ä¸€æ®µæ—¶é—´
    time.Sleep(5 * time.Second)
    
    // ä¼˜é›…å…³é—­
    manager.StopAll(ctx)
}
```

### é«˜çº§æ’ä»¶ç¤ºä¾‹

```go
package main

import (
    "context"
    "time"
    "github.com/qiaojinxia/distributed-service/framework/plugin"
    "github.com/qiaojinxia/distributed-service/framework/database"
)

// æ•°æ®åº“æ’ä»¶
type DatabasePlugin struct {
    plugin.BasePlugin
    config *DatabaseConfig
    db     *database.MySQL
}

type DatabaseConfig struct {
    Host     string `yaml:"host"`
    Port     int    `yaml:"port"`
    Database string `yaml:"database"`
    Username string `yaml:"username"`
    Password string `yaml:"password"`
}

func (p *DatabasePlugin) Name() string {
    return "database-plugin"
}

func (p *DatabasePlugin) Version() string {
    return "2.1.0"
}

func (p *DatabasePlugin) Initialize(ctx context.Context, config interface{}) error {
    cfg := config.(*DatabaseConfig)
    p.config = cfg
    
    // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    dbConfig := database.MySQLConfig{
        Host:     cfg.Host,
        Port:     cfg.Port,
        Database: cfg.Database,
        Username: cfg.Username,
        Password: cfg.Password,
    }
    
    db, err := database.NewMySQL(dbConfig)
    if err != nil {
        return err
    }
    
    p.db = db
    return nil
}

func (p *DatabasePlugin) Start(ctx context.Context) error {
    // æ³¨å†Œæ•°æ®åº“æœåŠ¡
    p.Registry().RegisterService("database", p.db)
    
    // è®¢é˜…æ•°æ®ç›¸å…³äº‹ä»¶
    p.EventBus().Subscribe("data.save", p.handleSaveData)
    p.EventBus().Subscribe("data.query", p.handleQueryData)
    
    return nil
}

func (p *DatabasePlugin) handleSaveData(event plugin.Event) {
    table := event.Data["table"].(string)
    data := event.Data["data"].(map[string]interface{})
    
    // ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“
    result := p.db.Table(table).Create(data)
    if result.Error != nil {
        p.Logger().Error("Failed to save data", plugin.Err(result.Error))
        return
    }
    
    // å‘å¸ƒä¿å­˜æˆåŠŸäº‹ä»¶
    p.EventBus().Publish(plugin.Event{
        Type: "data.saved",
        Data: map[string]interface{}{
            "table": table,
            "id":    result.Statement.Dest,
        },
    })
}

func (p *DatabasePlugin) handleQueryData(event plugin.Event) {
    query := event.Data["query"].(string)
    params := event.Data["params"].([]interface{})
    
    var results []map[string]interface{}
    p.db.Raw(query, params...).Scan(&results)
    
    // å‘å¸ƒæŸ¥è¯¢ç»“æœ
    p.EventBus().Publish(plugin.Event{
        Type: "data.query_result",
        Data: map[string]interface{}{
            "query":   query,
            "results": results,
        },
    })
}
```

### æ’ä»¶é—´é€šä¿¡

```go
package main

import (
    "github.com/qiaojinxia/distributed-service/framework/plugin"
)

// é€šçŸ¥æ’ä»¶
type NotificationPlugin struct {
    plugin.BasePlugin
    emailService *EmailService
    smsService   *SMSService
}

func (p *NotificationPlugin) Start(ctx context.Context) error {
    // ç›‘å¬æ¬¢è¿äº‹ä»¶
    p.EventBus().Subscribe("user.welcome", p.sendWelcomeNotification)
    
    // ç›‘å¬è®¢å•äº‹ä»¶
    p.EventBus().Subscribe("order.created", p.sendOrderConfirmation)
    
    return nil
}

func (p *NotificationPlugin) sendWelcomeNotification(event plugin.Event) {
    userID := event.Data["user_id"].(string)
    message := event.Data["message"].(string)
    
    // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆé€šè¿‡è°ƒç”¨å…¶ä»–æ’ä»¶æœåŠ¡ï¼‰
    userService := p.Registry().GetService("user-service")
    user := userService.GetUser(userID)
    
    // å‘é€æ¬¢è¿é‚®ä»¶
    p.emailService.Send(EmailMessage{
        To:      user.Email,
        Subject: "æ¬¢è¿æ³¨å†Œ",
        Body:    message,
    })
    
    p.Logger().Info("Welcome notification sent", 
        plugin.String("user_id", userID))
}

// ç”¨æˆ·æœåŠ¡æ’ä»¶
type UserServicePlugin struct {
    plugin.BasePlugin
    userRepo *UserRepository
}

func (p *UserServicePlugin) Start(ctx context.Context) error {
    // æ³¨å†Œç”¨æˆ·æœåŠ¡
    p.Registry().RegisterService("user-service", &UserService{
        repo: p.userRepo,
    })
    
    return nil
}

type UserService struct {
    repo *UserRepository
}

func (s *UserService) GetUser(userID string) *User {
    return s.repo.FindByID(userID)
}
```

## ğŸ”§ é…ç½®é€‰é¡¹

### æ’ä»¶ç®¡ç†å™¨é…ç½®

```go
type ManagerConfig struct {
    // åŸºç¡€é…ç½®
    PluginDir      string        `yaml:"plugin_dir"`      // æ’ä»¶ç›®å½•
    ConfigDir      string        `yaml:"config_dir"`      // é…ç½®ç›®å½•
    DataDir        string        `yaml:"data_dir"`        // æ•°æ®ç›®å½•
    
    // å¹¶å‘é…ç½®
    MaxConcurrency int           `yaml:"max_concurrency"` // æœ€å¤§å¹¶å‘æ•°
    Timeout        time.Duration `yaml:"timeout"`         // æ“ä½œè¶…æ—¶
    
    // å®‰å…¨é…ç½®
    EnableSandbox  bool          `yaml:"enable_sandbox"`  // å¯ç”¨æ²™ç®±
    MaxMemory      int64         `yaml:"max_memory"`      // æœ€å¤§å†…å­˜(MB)
    MaxCPU         float64       `yaml:"max_cpu"`         // æœ€å¤§CPUä½¿ç”¨ç‡
    
    // ç›‘æ§é…ç½®
    EnableMetrics  bool          `yaml:"enable_metrics"`  // å¯ç”¨æŒ‡æ ‡æ”¶é›†
    MetricsPort    int           `yaml:"metrics_port"`    // æŒ‡æ ‡ç«¯å£
    
    // çƒ­æ›´æ–°é…ç½®
    EnableHotReload bool         `yaml:"enable_hot_reload"` // å¯ç”¨çƒ­é‡è½½
    WatchInterval   time.Duration `yaml:"watch_interval"`   // ç›‘æ§é—´éš”
}
```

### æ’ä»¶é…ç½®

```go
type PluginConfig struct {
    // åŸºæœ¬ä¿¡æ¯
    Name        string            `yaml:"name"`
    Version     string            `yaml:"version"`
    Enabled     bool              `yaml:"enabled"`
    
    // ä¾èµ–é…ç½®
    Dependencies []string          `yaml:"dependencies"`
    Conflicts    []string          `yaml:"conflicts"`
    
    // èµ„æºé™åˆ¶
    Resources   ResourceLimits    `yaml:"resources"`
    
    // æƒé™é…ç½®
    Permissions []Permission      `yaml:"permissions"`
    
    // è‡ªå®šä¹‰é…ç½®
    Config      map[string]interface{} `yaml:"config"`
}

type ResourceLimits struct {
    Memory    int64   `yaml:"memory"`     // å†…å­˜é™åˆ¶(MB)
    CPU       float64 `yaml:"cpu"`        // CPUé™åˆ¶
    Goroutines int    `yaml:"goroutines"` // åç¨‹æ•°é™åˆ¶
    FileHandles int   `yaml:"file_handles"` // æ–‡ä»¶å¥æŸ„é™åˆ¶
}

type Permission struct {
    Resource string   `yaml:"resource"` // èµ„æºç±»å‹
    Actions  []string `yaml:"actions"`  // å…è®¸çš„æ“ä½œ
}
```

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# config/plugin_manager.yaml
plugin_manager:
  plugin_dir: "./plugins"
  config_dir: "./config/plugins"
  data_dir: "./data/plugins"
  
  max_concurrency: 10
  timeout: "30s"
  
  enable_sandbox: true
  max_memory: 512      # 512MB
  max_cpu: 0.5         # 50% CPU
  
  enable_metrics: true
  metrics_port: 9090
  
  enable_hot_reload: true
  watch_interval: "5s"

# config/plugins/hello-plugin.yaml
hello-plugin:
  name: "hello-plugin"
  version: "1.0.0"
  enabled: true
  
  dependencies:
    - "logger-plugin"
    
  resources:
    memory: 64        # 64MB
    cpu: 0.1          # 10% CPU
    goroutines: 100
    file_handles: 50
    
  permissions:
    - resource: "event_bus"
      actions: ["publish", "subscribe"]
    - resource: "logger"
      actions: ["write"]
      
  config:
    message: "æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„æœåŠ¡ï¼"
    max_notifications: 1000
    retry_count: 3
```

## ğŸ“Š ç›‘æ§ä¸æŒ‡æ ‡

### æ’ä»¶è¿è¡ŒæŒ‡æ ‡

```go
type PluginMetrics struct {
    // åŸºç¡€æŒ‡æ ‡
    Name           string        `json:"name"`
    Status         string        `json:"status"`         // running, stopped, error
    Uptime         time.Duration `json:"uptime"`
    RestartCount   int           `json:"restart_count"`
    
    // èµ„æºä½¿ç”¨
    MemoryUsage    int64         `json:"memory_usage"`   // MB
    CPUUsage       float64       `json:"cpu_usage"`      // ç™¾åˆ†æ¯”
    GoroutineCount int           `json:"goroutine_count"`
    
    // äº‹ä»¶å¤„ç†
    EventsReceived int64         `json:"events_received"`
    EventsPublished int64        `json:"events_published"`
    EventErrors    int64         `json:"event_errors"`
    
    // æ€§èƒ½æŒ‡æ ‡
    AvgProcessTime time.Duration `json:"avg_process_time"`
    MaxProcessTime time.Duration `json:"max_process_time"`
    ErrorRate      float64       `json:"error_rate"`
}
```

### ç³»ç»Ÿçº§æŒ‡æ ‡

```go
type SystemMetrics struct {
    // æ’ä»¶ç»Ÿè®¡
    TotalPlugins    int `json:"total_plugins"`
    RunningPlugins  int `json:"running_plugins"`
    FailedPlugins   int `json:"failed_plugins"`
    
    // äº‹ä»¶æ€»çº¿
    EventQueueSize  int   `json:"event_queue_size"`
    EventThroughput int64 `json:"event_throughput"` // events/sec
    
    // èµ„æºä½¿ç”¨
    TotalMemoryUsage int64   `json:"total_memory_usage"`
    TotalCPUUsage    float64 `json:"total_cpu_usage"`
    
    // ä¾èµ–å…³ç³»
    DependencyConflicts int `json:"dependency_conflicts"`
    CircularDependencies int `json:"circular_dependencies"`
}
```

## ğŸ” æœ€ä½³å®è·µ

### 1. æ’ä»¶è®¾è®¡åŸåˆ™

```go
// âœ… æ¨èï¼šå•ä¸€èŒè´£
type AuthPlugin struct {
    plugin.BasePlugin
    // åªè´Ÿè´£è®¤è¯ç›¸å…³åŠŸèƒ½
}

// âœ… æ¨èï¼šä¾èµ–æ³¨å…¥
func (p *AuthPlugin) Initialize(ctx context.Context, config interface{}) error {
    // é€šè¿‡ä¾èµ–æ³¨å…¥è·å–æ‰€éœ€æœåŠ¡
    p.cache = p.Registry().GetService("cache")
    p.database = p.Registry().GetService("database")
    return nil
}

// âœ… æ¨èï¼šä¼˜é›…é”™è¯¯å¤„ç†
func (p *AuthPlugin) handleAuthEvent(event plugin.Event) {
    defer func() {
        if r := recover(); r != nil {
            p.Logger().Error("Auth event handler panic", 
                plugin.Any("panic", r))
        }
    }()
    
    // å¤„ç†é€»è¾‘...
}
```

### 2. æ€§èƒ½ä¼˜åŒ–

```go
// âœ… æ¨èï¼šäº‹ä»¶è¿‡æ»¤
func (p *MyPlugin) Start(ctx context.Context) error {
    // åªè®¢é˜…éœ€è¦çš„äº‹ä»¶
    p.EventBus().SubscribeWithFilter("user.*", p.handleUserEvents, func(event plugin.Event) bool {
        return event.Data["priority"] == "high"
    })
    
    return nil
}

// âœ… æ¨èï¼šæ‰¹é‡å¤„ç†
func (p *MyPlugin) handleBatchEvents(events []plugin.Event) {
    // æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
    for _, event := range events {
        p.processEvent(event)
    }
}

// âœ… æ¨èï¼šèµ„æºæ± åŒ–
type ConnectionPool struct {
    connections chan *Connection
    maxSize     int
}

func (p *DatabasePlugin) Initialize(ctx context.Context, config interface{}) error {
    p.connectionPool = NewConnectionPool(10)
    return nil
}
```

### 3. å®‰å…¨è€ƒè™‘

```go
// âœ… æ¨èï¼šæƒé™æ£€æŸ¥
func (p *FilePlugin) writeFile(path string, data []byte) error {
    if !p.HasPermission("file.write") {
        return plugin.ErrPermissionDenied
    }
    
    // æ£€æŸ¥è·¯å¾„å®‰å…¨æ€§
    if !isSecurePath(path) {
        return plugin.ErrInvalidPath
    }
    
    return os.WriteFile(path, data, 0644)
}

// âœ… æ¨èï¼šè¾“å…¥éªŒè¯
func (p *APIPlugin) handleAPICall(event plugin.Event) {
    // éªŒè¯è¾“å…¥
    if err := p.validateInput(event.Data); err != nil {
        p.Logger().Warn("Invalid input", plugin.Err(err))
        return
    }
    
    // å¤„ç†è¯·æ±‚...
}
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q1: æ’ä»¶åŠ è½½å¤±è´¥**
```go
// æ£€æŸ¥æ’ä»¶ä¾èµ–
func (m *Manager) validateDependencies(plugin Plugin) error {
    for _, dep := range plugin.Dependencies() {
        if !m.IsLoaded(dep) {
            return fmt.Errorf("dependency %s not loaded", dep)
        }
    }
    return nil
}

// æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§
func (m *Manager) checkCompatibility(plugin Plugin) error {
    version := plugin.Version()
    if !m.isVersionCompatible(version) {
        return fmt.Errorf("incompatible version: %s", version)
    }
    return nil
}
```

**Q2: å†…å­˜æ³„æ¼é—®é¢˜**
```go
// ç›‘æ§å†…å­˜ä½¿ç”¨
func (m *Manager) monitorMemory() {
    ticker := time.NewTicker(time.Minute)
    defer ticker.Stop()
    
    for range ticker.C {
        for _, plugin := range m.plugins {
            usage := plugin.GetMemoryUsage()
            if usage > plugin.GetMemoryLimit() {
                m.Logger().Warn("Plugin memory usage high",
                    plugin.String("plugin", plugin.Name()),
                    plugin.Int64("usage", usage))
            }
        }
    }
}

// å¼ºåˆ¶åƒåœ¾å›æ”¶
func (p *BasePlugin) forceGC() {
    runtime.GC()
    runtime.GC() // å¼ºåˆ¶ä¸¤æ¬¡GC
}
```

**Q3: äº‹ä»¶å¤„ç†æ­»é”**
```go
// å¸¦è¶…æ—¶çš„äº‹ä»¶å¤„ç†
func (p *MyPlugin) handleEventWithTimeout(event plugin.Event) {
    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
    defer cancel()
    
    done := make(chan struct{})
    go func() {
        defer close(done)
        p.processEvent(event)
    }()
    
    select {
    case <-done:
        // å¤„ç†å®Œæˆ
    case <-ctx.Done():
        p.Logger().Error("Event processing timeout")
    }
}
```

## ğŸ”® é«˜çº§åŠŸèƒ½

### æ’ä»¶çƒ­æ›´æ–°

```go
func (m *Manager) HotReload(pluginName string) error {
    // åœæ­¢æ—§ç‰ˆæœ¬
    if err := m.StopPlugin(pluginName); err != nil {
        return err
    }
    
    // é‡æ–°åŠ è½½
    if err := m.ReloadPlugin(pluginName); err != nil {
        return err
    }
    
    // å¯åŠ¨æ–°ç‰ˆæœ¬
    return m.StartPlugin(pluginName)
}
```

### æ’ä»¶é›†ç¾¤

```go
type ClusterManager struct {
    localManager  *Manager
    remoteManagers map[string]*RemoteManager
    coordinator   *Coordinator
}

func (cm *ClusterManager) DistributePlugin(plugin Plugin, nodes []string) error {
    for _, node := range nodes {
        if err := cm.deployToNode(plugin, node); err != nil {
            return err
        }
    }
    return nil
}
```

---

> æ’ä»¶æ¨¡å—ä¸ºæ¡†æ¶æä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½ã€çƒ­æ›´æ–°å’Œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå®ç°äº†çœŸæ­£çš„å¾®å†…æ ¸æ¶æ„ã€‚