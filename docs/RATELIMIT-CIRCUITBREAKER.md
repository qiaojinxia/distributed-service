# ğŸ›¡ï¸ APIé™æµå’Œç†”æ–­å™¨ä½¿ç”¨æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¡†æ¶é›†æˆäº†å®Œæ•´çš„APIé™æµå’Œç†”æ–­å™¨åŠŸèƒ½ï¼Œæä¾›å¤šå±‚æ¬¡çš„ç³»ç»Ÿä¿æŠ¤æœºåˆ¶ï¼š

- **ğŸš« APIé™æµ**: é˜²æ­¢æ¶æ„è¯·æ±‚å’Œç³»ç»Ÿè¿‡è½½
- **ğŸ”¥ ç†”æ–­å™¨**: é˜²æ­¢æœåŠ¡é›ªå´©å’Œçº§è”æ•…éšœ
- **ğŸ“Š å®æ—¶ç›‘æ§**: æä¾›è¯¦ç»†çš„é™æµå’Œç†”æ–­çŠ¶æ€ç›‘æ§

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

é™æµå’Œç†”æ–­å™¨å·²è‡ªåŠ¨é›†æˆåˆ°æ‰€æœ‰APIç«¯ç‚¹ä¸­ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯ä½¿ç”¨ã€‚

### 2. æµ‹è¯•åŠŸèƒ½

```bash
# è¿è¡Œå®Œæ•´çš„é™æµå’Œç†”æ–­å™¨æµ‹è¯•
./scripts/test-ratelimit-circuitbreaker.sh

# æŸ¥çœ‹ç†”æ–­å™¨çŠ¶æ€
curl http://localhost:8080/circuit-breaker/status

# æŸ¥çœ‹Hystrixç›‘æ§æµ
curl http://localhost:8080/hystrix
```

## ğŸ“Š é™æµåŠŸèƒ½

### é™æµç±»å‹

#### 1. IPé™æµ
åŸºäºå®¢æˆ·ç«¯IPåœ°å€çš„é™æµï¼Œé€‚ç”¨äºå…¬å¼€APIç«¯ç‚¹ã€‚

```go
// ç¤ºä¾‹ï¼šæ¯ç§’10æ¬¡è¯·æ±‚
r.GET("/health", rateLimiter.IPRateLimit("10-S"), handler)
```

#### 2. ç”¨æˆ·é™æµ
åŸºäºè®¤è¯ç”¨æˆ·IDçš„é™æµï¼Œé€‚ç”¨äºéœ€è¦ç™»å½•çš„APIã€‚

```go
// ç¤ºä¾‹ï¼šæ¯åˆ†é’Ÿ50æ¬¡è¯·æ±‚
r.GET("/api/v1/users/me", rateLimiter.UserRateLimit("50-M"), handler)
```

#### 3. è‡ªå®šä¹‰é™æµ
åŸºäºè‡ªå®šä¹‰é”®å€¼å‡½æ•°çš„é™æµã€‚

```go
// æŒ‰ç«¯ç‚¹é™æµ
r.GET("/api", rateLimiter.CustomRateLimit(ratelimit.KeyFunctions.ByEndpoint, "100-M"), handler)
```

### é™æµé…ç½®æ ¼å¼

é™æµé…ç½®ä½¿ç”¨ `æ•°é‡-æ—¶é—´å•ä½` æ ¼å¼ï¼š

- `10-S`: æ¯ç§’10æ¬¡
- `100-M`: æ¯åˆ†é’Ÿ100æ¬¡  
- `1000-H`: æ¯å°æ—¶1000æ¬¡
- `5000-D`: æ¯å¤©5000æ¬¡

### å½“å‰é™æµé…ç½®

| ç«¯ç‚¹ç±»å‹ | é™æµè§„åˆ™ | è¯´æ˜ |
|----------|----------|------|
| å¥åº·æ£€æŸ¥ | 10æ¬¡/ç§’ | åŸºäºIPé™æµ |
| è®¤è¯ç«¯ç‚¹ | 20æ¬¡/åˆ†é’Ÿ | åŸºäºIPé™æµ |
| å—ä¿æŠ¤è®¤è¯ | 10æ¬¡/åˆ†é’Ÿ | åŸºäºç”¨æˆ·é™æµ |
| å…¬å¼€ç”¨æˆ·API | 30æ¬¡/åˆ†é’Ÿ | åŸºäºIPé™æµ |
| å—ä¿æŠ¤ç”¨æˆ·API | 50æ¬¡/åˆ†é’Ÿ | åŸºäºç”¨æˆ·é™æµ |

### é™æµå“åº”

å½“è§¦å‘é™æµæ—¶ï¼ŒAPIè¿”å›HTTP 429çŠ¶æ€ç ï¼š

```json
{
  "error": "Rate limit exceeded",
  "message": "Too many requests. Limit: 10 per 1m0s",
  "retry_after": 1640995200
}
```

å“åº”å¤´åŒ…å«é™æµä¿¡æ¯ï¼š
- `X-RateLimit-Limit`: é™æµé˜ˆå€¼
- `X-RateLimit-Remaining`: å‰©ä½™è¯·æ±‚æ•°
- `X-RateLimit-Reset`: é‡ç½®æ—¶é—´æˆ³

## ğŸ”¥ ç†”æ–­å™¨åŠŸèƒ½

### ç†”æ–­å™¨é…ç½®

#### é»˜è®¤é…ç½®

| æœåŠ¡ç±»å‹ | è¶…æ—¶æ—¶é—´ | æœ€å¤§å¹¶å‘ | è¯·æ±‚é˜ˆå€¼ | é”™è¯¯ç‡é˜ˆå€¼ | ä¼‘çœ çª—å£ |
|----------|----------|----------|----------|------------|----------|
| æ•°æ®åº“ | 5ç§’ | 100 | 20 | 50% | 10ç§’ |
| å¤–éƒ¨API | 3ç§’ | 50 | 10 | 30% | 5ç§’ |
| ç¼“å­˜ | 1ç§’ | 200 | 5 | 60% | 3ç§’ |

#### APIä¸“ç”¨é…ç½®

| APIç±»å‹ | è¶…æ—¶æ—¶é—´ | æœ€å¤§å¹¶å‘ | è¯·æ±‚é˜ˆå€¼ | é”™è¯¯ç‡é˜ˆå€¼ | ä¼‘çœ çª—å£ |
|---------|----------|----------|----------|------------|----------|
| ç”¨æˆ·æ³¨å†Œ | 3ç§’ | 20 | 10 | 30% | 5ç§’ |
| ç”¨æˆ·ç™»å½• | 3ç§’ | 30 | 15 | 25% | 5ç§’ |
| ç”¨æˆ·æŸ¥è¯¢ | 2ç§’ | 100 | 20 | 40% | 3ç§’ |

### ç†”æ–­å™¨çŠ¶æ€

#### çŠ¶æ€ç±»å‹
- **CLOSED**: æ­£å¸¸çŠ¶æ€ï¼Œè¯·æ±‚æ­£å¸¸é€šè¿‡
- **OPEN**: ç†”æ–­çŠ¶æ€ï¼Œè¯·æ±‚è¢«æ‹’ç»å¹¶æ‰§è¡Œé™çº§
- **HALF_OPEN**: åŠå¼€çŠ¶æ€ï¼Œå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æœåŠ¡æ¢å¤

#### çŠ¶æ€æŸ¥è¯¢

```bash
# æŸ¥çœ‹æ‰€æœ‰ç†”æ–­å™¨çŠ¶æ€
curl http://localhost:8080/circuit-breaker/status
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": "healthy",
  "open_circuits": [],
  "total_circuits": 6,
  "states": {
    "auth_login": {
      "name": "auth_login",
      "is_open": false,
      "request_count": 0,
      "error_count": 0,
      "error_percentage": 0
    }
  }
}
```

### ç†”æ–­å™¨é™çº§

å½“ç†”æ–­å™¨æ‰“å¼€æ—¶ï¼ŒAPIè¿”å›HTTP 503çŠ¶æ€ç ï¼š

```json
{
  "error": "Service Unavailable",
  "message": "The service is temporarily unavailable due to circuit breaker",
  "code": "CIRCUIT_BREAKER_OPEN"
}
```

## ğŸ“ˆ ç›‘æ§å’ŒæŒ‡æ ‡

### Hystrixç›‘æ§æµ

è®¿é—® `http://localhost:8080/hystrix` è·å–å®æ—¶ç›‘æ§æ•°æ®æµï¼Œå¯ç”¨äºï¼š

- Hystrix Dashboard
- è‡ªå®šä¹‰ç›‘æ§ç³»ç»Ÿ
- å®æ—¶å‘Šè­¦

### PrometheusæŒ‡æ ‡

ç†”æ–­å™¨ä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹æŒ‡æ ‡ï¼š

```promql
# ç†”æ–­å™¨è¯·æ±‚è®¡æ•°
circuit_breaker_requests_total{command="auth_login",status="success"}

# ç†”æ–­å™¨é”™è¯¯è®¡æ•°  
circuit_breaker_requests_total{command="auth_login",status="error"}
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰ç†”æ–­å™¨

```go
// é…ç½®è‡ªå®šä¹‰ç†”æ–­å™¨
circuitbreaker.ConfigureCommand("my_service", circuitbreaker.Config{
    Timeout:                2000, // 2ç§’è¶…æ—¶
    MaxConcurrentRequests:  50,   // æœ€å¤§50å¹¶å‘
    RequestVolumeThreshold: 10,   // 10ä¸ªè¯·æ±‚åå¼€å§‹ç»Ÿè®¡
    SleepWindow:            5000, // 5ç§’ä¼‘çœ çª—å£
    ErrorPercentThreshold:  30,   // 30%é”™è¯¯ç‡é˜ˆå€¼
})
```

### è‡ªå®šä¹‰é™çº§å¤„ç†

```go
// è‡ªå®šä¹‰é™çº§å‡½æ•°
fallbackHandler := func(c *gin.Context) {
    c.JSON(503, gin.H{
        "error": "Service temporarily unavailable",
        "fallback": true,
    })
}

// ä½¿ç”¨è‡ªå®šä¹‰é™çº§
r.GET("/api", circuitBreaker.Middleware("my_command", fallbackHandler), handler)
```

### ç¼–ç¨‹å¼ä½¿ç”¨

```go
// ç›´æ¥ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤ä»£ç 
result, err := circuitBreaker.ExecuteCommand("my_operation", 
    func() (interface{}, error) {
        // ä¸šåŠ¡é€»è¾‘
        return doSomething()
    }, 
    func(err error) (interface{}, error) {
        // é™çº§é€»è¾‘
        return getDefaultValue(), nil
    })
```

## ğŸ§ª æµ‹è¯•å’ŒéªŒè¯

### é™æµæµ‹è¯•

```bash
# å¿«é€Ÿå‘é€å¤šä¸ªè¯·æ±‚æµ‹è¯•é™æµ
for i in {1..20}; do
    curl -w "HTTP_%{http_code}\n" http://localhost:8080/health
    sleep 0.1
done
```

### ç†”æ–­å™¨æµ‹è¯•

```bash
# å‘é€å¤§é‡é”™è¯¯è¯·æ±‚è§¦å‘ç†”æ–­å™¨
for i in {1..30}; do
    curl -w "HTTP_%{http_code}\n" http://localhost:8080/api/v1/users/999
    sleep 0.1
done
```

### è‡ªåŠ¨åŒ–æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
./scripts/test-ratelimit-circuitbreaker.sh
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. é™æµä¸ç”Ÿæ•ˆ
- æ£€æŸ¥é™æµé…ç½®æ ¼å¼æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ä¸­é—´ä»¶æ˜¯å¦æ­£ç¡®åº”ç”¨åˆ°è·¯ç”±
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

#### 2. ç†”æ–­å™¨æœªè§¦å‘
- ç¡®è®¤è¯·æ±‚é‡æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
- æ£€æŸ¥é”™è¯¯ç‡æ˜¯å¦è¶…è¿‡é…ç½®å€¼
- éªŒè¯ç†”æ–­å™¨é…ç½®æ˜¯å¦æ­£ç¡®

#### 3. ç›‘æ§æ•°æ®ç¼ºå¤±
- ç¡®è®¤Hystrixæµç«¯ç‚¹å¯è®¿é—®
- æ£€æŸ¥PrometheusæŒ‡æ ‡æ˜¯å¦æ­£å¸¸æš´éœ²
- éªŒè¯ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

### è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹é™æµçŠ¶æ€
curl -I http://localhost:8080/health

# æŸ¥çœ‹ç†”æ–­å™¨çŠ¶æ€
curl http://localhost:8080/circuit-breaker/status

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f app

# æŸ¥çœ‹PrometheusæŒ‡æ ‡
curl http://localhost:9090/metrics | grep circuit_breaker
```

## ğŸ“š æœ€ä½³å®è·µ

### é™æµé…ç½®å»ºè®®

1. **åˆ†å±‚é™æµ**: ä¸åŒç±»å‹çš„APIä½¿ç”¨ä¸åŒçš„é™æµç­–ç•¥
2. **åˆç†é˜ˆå€¼**: æ ¹æ®ç³»ç»Ÿå®¹é‡å’Œä¸šåŠ¡éœ€æ±‚è®¾ç½®é™æµé˜ˆå€¼
3. **ç”¨æˆ·å‹å¥½**: æä¾›æ¸…æ™°çš„é™æµé”™è¯¯ä¿¡æ¯å’Œé‡è¯•å»ºè®®
4. **ç›‘æ§å‘Šè­¦**: è®¾ç½®é™æµè§¦å‘çš„ç›‘æ§å‘Šè­¦

### ç†”æ–­å™¨é…ç½®å»ºè®®

1. **å¿«é€Ÿå¤±è´¥**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
2. **æ¸è¿›æ¢å¤**: ä½¿ç”¨åŠå¼€çŠ¶æ€é€æ­¥æ¢å¤æœåŠ¡
3. **é™çº§ç­–ç•¥**: ä¸ºæ¯ä¸ªå…³é”®æœåŠ¡å‡†å¤‡é™çº§æ–¹æ¡ˆ
4. **ç›‘æ§è§‚å¯Ÿ**: æŒç»­ç›‘æ§ç†”æ–­å™¨çŠ¶æ€å’Œè§¦å‘é¢‘ç‡

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **æ€§èƒ½æµ‹è¯•**: åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¿›è¡Œå……åˆ†çš„æ€§èƒ½æµ‹è¯•
2. **å®¹é‡è§„åˆ’**: æ ¹æ®ä¸šåŠ¡å¢é•¿é¢„æœŸè°ƒæ•´é™æµå’Œç†”æ–­é…ç½®
3. **å‘Šè­¦è®¾ç½®**: é…ç½®é™æµå’Œç†”æ–­çš„å®æ—¶å‘Šè­¦
4. **å®šæœŸå›é¡¾**: å®šæœŸå›é¡¾å’Œä¼˜åŒ–é…ç½®å‚æ•°

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæŒ‡å—](TRACING.md)
- [ç›‘æ§æŒ‡æ ‡è¯´æ˜](../README-Docker.md#ç›‘æ§å’ŒæŒ‡æ ‡)
- [éƒ¨ç½²æ–‡æ¡£](../README-Docker.md)
- [é¡¹ç›®è·¯çº¿å›¾](ROADMAP.md) 