# èµ„æºå‘½åè§„èŒƒ

## ğŸ“š æ¦‚è¿°

ä¸ºäº†ç»Ÿä¸€ Sentinel ä¿æŠ¤æœºåˆ¶ä¸­é™æµå’Œç†”æ–­å™¨çš„èµ„æºå‘½åï¼Œæˆ‘ä»¬é‡‡ç”¨ç»Ÿä¸€çš„è·¯å¾„é£æ ¼å‘½åè§„èŒƒï¼Œå¹¶**æ”¯æŒé€šé…ç¬¦åŒ¹é…**æ¥ç®€åŒ–é…ç½®ã€‚

## ğŸ¯ å‘½åè§„èŒƒ

### ç»Ÿä¸€åŸåˆ™
- æ‰€æœ‰ `resource` å­—æ®µéƒ½ä½¿ç”¨ **è·¯å¾„é£æ ¼** (`/path/to/resource`)
- **æ”¯æŒé€šé…ç¬¦æ¨¡å¼** (`*` åŒ¹é…ä»»æ„å­—ç¬¦)
- **æ”¯æŒå¤šæ¨¡å¼åŒ¹é…** (ä½¿ç”¨é€—å·åˆ†éš”å¤šä¸ªæ¨¡å¼)
- å±‚æ¬¡ç»“æ„æ¸…æ™°ï¼Œä¾¿äºç®¡ç†å’Œè¯†åˆ«
- é™æµè§„åˆ™å’Œç†”æ–­å™¨ä½¿ç”¨ç›¸åŒçš„å‘½åè§„èŒƒ

### é€šé…ç¬¦è§„åˆ™
```yaml
# å•ä¸€é€šé…ç¬¦åŒ¹é…
/api/v1/users/*                          # åŒ¹é…æ‰€æœ‰ç”¨æˆ·ç›¸å…³æ¥å£

# å¤šæ¨¡å¼åŒ¹é… (é€—å·åˆ†éš”)
/grpc/*/get*,/grpc/*/list*,/grpc/*/find* # åŒ¹é…æ‰€æœ‰gRPCè¯»æ“ä½œ

# å…·ä½“è·¯å¾„åŒ¹é…
/health                                   # ç²¾ç¡®åŒ¹é…å¥åº·æ£€æŸ¥æ¥å£

# å±‚çº§é€šé…ç¬¦
/api/*                                    # åŒ¹é…æ‰€æœ‰APIæ¥å£ (å…œåº•)
```

### åˆ†ç±»è§„èŒƒ

#### 1. HTTP API èµ„æº
```yaml
# å…·ä½“æ¥å£
/health                          # å¥åº·æ£€æŸ¥

# æ¨¡å—çº§åˆ«é€šé…ç¬¦
/api/v1/auth/*                   # æ‰€æœ‰è®¤è¯æ¥å£ (login, register, refreshç­‰)
/api/v1/users/*                  # æ‰€æœ‰ç”¨æˆ·æ¥å£ (CRUDæ“ä½œ)
/protection/*                    # æ‰€æœ‰ä¿æŠ¤çŠ¶æ€æ¥å£

# é€šç”¨å…œåº•
/api/*                           # æ‰€æœ‰APIæ¥å£å…œåº•é™æµ
```

#### 2. gRPC æœåŠ¡èµ„æº
```yaml
# æœåŠ¡çº§åˆ«é€šé…ç¬¦
/grpc/user_service/*             # æ‰€æœ‰ç”¨æˆ·æœåŠ¡æ–¹æ³•

# æ“ä½œç±»å‹åŒ¹é…
/grpc/*/get*,/grpc/*/list*,/grpc/*/find*     # æ‰€æœ‰è¯»æ“ä½œ
/grpc/*/create*,/grpc/*/update*,/grpc/*/delete*  # æ‰€æœ‰å†™æ“ä½œ

# å…·ä½“æ–¹æ³• (å¦‚éœ€è¦ç‰¹æ®Šé…ç½®)
/grpc/user_service/get_user      # ç‰¹å®šæ–¹æ³•
```

#### 3. åŸºç¡€è®¾æ–½èµ„æº
```yaml
# ç»Ÿä¸€åŸºç¡€è®¾æ–½
/infrastructure/*                # æ‰€æœ‰åŸºç¡€è®¾æ–½ (database, redis, mqç­‰)

# å…·ä½“ç»„ä»¶ (å¦‚éœ€è¦å·®å¼‚åŒ–é…ç½®)
/infrastructure/database         # æ•°æ®åº“æ“ä½œ
/infrastructure/redis           # Redisæ“ä½œ
```

#### 4. å¤–éƒ¨ä¾èµ–èµ„æº
```yaml
# ç»Ÿä¸€å¤–éƒ¨ä¾èµ–
/external/*                      # æ‰€æœ‰å¤–éƒ¨æœåŠ¡è°ƒç”¨

# å…·ä½“æœåŠ¡ (å¦‚éœ€è¦å·®å¼‚åŒ–é…ç½®)
/external/payment_gateway        # æ”¯ä»˜ç½‘å…³
/external/notification_service   # é€šçŸ¥æœåŠ¡
```

## ğŸ“‹ é…ç½®ç¤ºä¾‹

### ç®€åŒ–çš„é™æµè§„åˆ™é…ç½®
```yaml
rate_limit_rules:
  # å¥åº·æ£€æŸ¥ - ç²¾ç¡®åŒ¹é…
  - name: "health_check_limiter"
    resource: "/health"
    threshold: 2
    stat_interval_ms: 1000
    
  # è®¤è¯æ¥å£ - é€šé…ç¬¦åŒ¹é…
  - name: "auth_api_limiter"
    resource: "/api/v1/auth/*"          # åŒ¹é…æ‰€æœ‰è®¤è¯æ¥å£
    threshold: 10
    stat_interval_ms: 60000
    
  # ç”¨æˆ·æ¥å£ - é€šé…ç¬¦åŒ¹é…
  - name: "users_api_limiter"
    resource: "/api/v1/users/*"         # åŒ¹é…æ‰€æœ‰ç”¨æˆ·æ¥å£
    threshold: 30
    stat_interval_ms: 60000
    
  # gRPCè¯»æ“ä½œ - å¤šæ¨¡å¼åŒ¹é…
  - name: "grpc_read_operations_limiter"
    resource: "/grpc/*/get*,/grpc/*/list*,/grpc/*/find*"
    threshold: 80
    stat_interval_ms: 1000
    
  # APIå…œåº•é™æµ - é€šç”¨é€šé…ç¬¦
  - name: "api_general_limiter"
    resource: "/api/*"                  # å…œåº•ä¿æŠ¤æ‰€æœ‰API
    threshold: 100
    stat_interval_ms: 60000
```

### ç®€åŒ–çš„ç†”æ–­å™¨é…ç½®
```yaml
circuit_breakers:
  # è®¤è¯æ¥å£ç†”æ–­ - é€šé…ç¬¦åŒ¹é…
  - name: "auth_api_circuit"
    resource: "/api/v1/auth/*"          # ä¿æŠ¤æ‰€æœ‰è®¤è¯æ¥å£
    strategy: "ErrorRatio"
    threshold: 0.5
    
  # gRPCç”¨æˆ·æœåŠ¡ç†”æ–­ - æœåŠ¡çº§é€šé…ç¬¦
  - name: "grpc_user_service_circuit"
    resource: "/grpc/user_service/*"    # ä¿æŠ¤æ•´ä¸ªç”¨æˆ·æœåŠ¡
    strategy: "SlowRequestRatio"
    threshold: 0.3
    
  # åŸºç¡€è®¾æ–½ç†”æ–­ - ç»Ÿä¸€ä¿æŠ¤
  - name: "infrastructure_circuit"
    resource: "/infrastructure/*"       # ä¿æŠ¤æ‰€æœ‰åŸºç¡€è®¾æ–½
    strategy: "ErrorRatio"
    threshold: 0.5
```

## âœ… ä¼˜åŠ¿

### é…ç½®ç®€åŒ–
- **ä» 13 ä¸ªé™æµè§„åˆ™å‡å°‘åˆ° 8 ä¸ª**
- **ä» 8 ä¸ªç†”æ–­å™¨å‡å°‘åˆ° 7 ä¸ª**
- ç»´æŠ¤æ›´å®¹æ˜“ï¼Œé…ç½®æ›´æ¸…æ™°

### é€šé…ç¬¦åŒ¹é…ä¼˜åŠ¿
1. **çµæ´»æ€§**: ä¸€ä¸ªè§„åˆ™è¦†ç›–å¤šä¸ªç›¸ä¼¼èµ„æº
2. **å¯ç»´æŠ¤æ€§**: æ–°å¢æ¥å£æ— éœ€ä¿®æ”¹é…ç½®
3. **å±‚æ¬¡åŒ–ä¿æŠ¤**: æ”¯æŒç»†ç²’åº¦åˆ°ç²—ç²’åº¦çš„ä¿æŠ¤ç­–ç•¥
4. **å…œåº•æœºåˆ¶**: é€šç”¨è§„åˆ™ç¡®ä¿å…¨è¦†ç›–

### åŒ¹é…ä¼˜å…ˆçº§
```yaml
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½:
1. ç²¾ç¡®åŒ¹é…: /health
2. å…·ä½“é€šé…ç¬¦: /api/v1/auth/*
3. å¤šæ¨¡å¼åŒ¹é…: /grpc/*/get*,/grpc/*/list*
4. é€šç”¨é€šé…ç¬¦: /api/*
```

## ğŸš€ è¿ç§»æŒ‡å—

### é…ç½®å¯¹æ¯”

| åœºæ™¯ | æ—§é…ç½® (è¯¦ç»†) | æ–°é…ç½® (ç®€åŒ–) |
|------|---------------|---------------|
| ç™»å½•æ¥å£ | `/api/v1/auth/login` | `/api/v1/auth/*` |
| æ³¨å†Œæ¥å£ | `/api/v1/auth/register` | `/api/v1/auth/*` |
| è·å–ç”¨æˆ· | `/grpc/user_service/get_user` | `/grpc/*/get*` |
| åˆ›å»ºç”¨æˆ· | `/grpc/user_service/create_user` | `/grpc/*/create*` |
| æ•°æ®åº“æ“ä½œ | `/infrastructure/database` | `/infrastructure/*` |
| Redisæ“ä½œ | `/infrastructure/redis` | `/infrastructure/*` |

### è¿ç§»æ­¥éª¤
1. **å¤‡ä»½ç°æœ‰é…ç½®**
2. **åº”ç”¨æ–°çš„ç®€åŒ–é…ç½®**
3. **éªŒè¯é€šé…ç¬¦åŒ¹é…æ­£å¸¸å·¥ä½œ**
4. **ç›‘æ§ä¿æŠ¤æ•ˆæœ**
5. **æ ¹æ®éœ€è¦å¾®è°ƒé˜ˆå€¼**

## ğŸ”§ å®ç°å»ºè®®

### ä»£ç ä¸­çš„åŒ¹é…é€»è¾‘
```go
// ç¤ºä¾‹: èµ„æºåŒ¹é…å‡½æ•°
func MatchResource(resource string, pattern string) bool {
    // æ”¯æŒå¤šæ¨¡å¼åŒ¹é… (é€—å·åˆ†éš”)
    patterns := strings.Split(pattern, ",")
    for _, p := range patterns {
        if matched, _ := filepath.Match(strings.TrimSpace(p), resource); matched {
            return true
        }
    }
    return false
}
```

### ç›‘æ§å’Œè°ƒè¯•
- è®°å½•åŒ¹é…çš„è§„åˆ™å’Œèµ„æº
- æä¾›è§„åˆ™åŒ¹é…çŠ¶æ€æŸ¥è¯¢æ¥å£
- æ”¯æŒåŠ¨æ€è°ƒæ•´é˜ˆå€¼

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é€šé…ç¬¦æ€§èƒ½**: é€šé…ç¬¦åŒ¹é…æ¯”ç²¾ç¡®åŒ¹é…ç•¥æ…¢ï¼Œä½†å·®å¼‚å¾ˆå°
2. **è§„åˆ™å†²çª**: ç¡®ä¿é€šé…ç¬¦è§„åˆ™ä¸ä¼šæ„å¤–åŒ¹é…åˆ°ä¸ç›¸å…³çš„èµ„æº
3. **æµ‹è¯•è¦†ç›–**: å……åˆ†æµ‹è¯•å„ç§è·¯å¾„åŒ¹é…åœºæ™¯
4. **ç›‘æ§è§‚å¯Ÿ**: ä¸Šçº¿åè§‚å¯Ÿä¿æŠ¤æ•ˆæœï¼ŒåŠæ—¶è°ƒæ•´

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Sentinelä¿æŠ¤æœºåˆ¶æµ‹è¯•æ–‡æ¡£](../test/README_Sentinel_Tests.md)
- [é…ç½®æ–‡ä»¶è¯´æ˜](../config/config.yaml)
- [ä¿æŠ¤æœºåˆ¶è®¾è®¡æ–‡æ¡£](./PROTECTION_DESIGN.md) 